{% extends 'movies/base.html' %}
{% load static %}

{% block title %}Movies - DubbedDB{% endblock %}

{% block content %}
<div class="container mt-5">
    <h1 class="mb-4">Movies</h1>

    <!-- Search, Sort, Filter Form -->
    <form method="GET" class="mb-4 p-4 border rounded bg-light">
        <div class="row g-3">
            <!-- Search -->
            <div class="col-md-12">
                <label for="q" class="form-label">Search Title</label>
                <input type="text" 
       name="q" 
       id="q" 
       value="{{ query|default:'' }}" 
       placeholder="e.g: Kralj Lavova" 
       class="form-control"
       hx-get="{% url 'movies' %}"
       hx-trigger="input changed delay:500ms"
       hx-target="#results-container"
       hx-include="[name='sort'], [name='direction'], [name='start_year'], [name='end_year'], [name='letter'], [name='company']">
            </div>

            <!-- Sorting -->
            <div class="col-md-6">
                <label for="sort" class="form-label">Sort By</label>
                <div class="input-group">
                    <select name="sort" id="sort" class="form-select">
                        <option value="title" {% if sort_by == 'title' %}selected{% endif %}>Title</option>
                        <option value="release_year" {% if sort_by == 'release_year' %}selected{% endif %}>Release Year</option>
                    </select>
                    <select name="direction" class="form-select" style="max-width: 100px;">
                        <option value="asc" {% if direction == 'asc' %}selected{% endif %}>Asc ↑</option>
                        <option value="desc" {% if direction == 'desc' %}selected{% endif %}>Desc ↓</option>
                    </select>
                </div>
            </div>

            <!-- Filter by Company -->
            <div class="col-md-6">
                <label for="company" class="form-label">Dubbing Company</label>
                <select name="company" id="company" class="form-select">
                    <option value="">All Companies</option>
                    {% for company in companies %}
                        <option value="{{ company.id }}" {% if company_id == company.id|stringformat:"s" %}selected{% endif %}>{{ company.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Filter by Year Range -->
            <div class="col-md-6">
                <label class="form-label">Release Year Range</label>
                <div class="input-group">
                    <input type="number" name="start_year" value="{{ start_year|default:'' }}" placeholder="From Year" class="form-control">
                    <span class="input-group-text">-</span>
                    <input type="number" name="end_year" value="{{ end_year|default:'' }}" placeholder="To Year" class="form-control">
                </div>
            </div>

            <!-- Filter by Starting Letter -->
            <div class="col-md-6">
                 <label class="form-label">Starting Letter</label>
                 <select name="letter" class="form-select">
                     <option value="">All Letters</option>
                     {% for char in alphabet %}
                         <option value="{{ char }}" {% if letter == char %}selected{% endif %}>{{ char }}</option>
                     {% endfor %}
                 </select>
            </div>
        </div>

        <!-- Submit Buttons -->
        <div class="mt-3 d-flex justify-content-end gap-2">
             <a href="{% url 'movies' %}" class="btn btn-secondary">Reset Filters</a>
             <button type="submit" class="btn btn-primary">Apply Filters</button>
        </div>
    </form>
    <!-- End Search, Sort, Filter Form -->

    <!-- Results Count -->
    <p class="text-muted mb-3">{{ movies.paginator.count }} movie{{ movies.paginator.count|pluralize }} found.</p>

    <!-- No Movies Found Message -->
    {% if not movies %}
        <div class="alert alert-warning text-center" role="alert">
            No movies match your criteria. Try adjusting the filters.
        </div>
    {% else %}
        <!-- Movies Grid -->
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
            {% for movie in movies %}
            <div class="col">
                <div class="card h-100 shadow-sm">
                     <a href="{% url 'movie_detail' movie.get_slug %}">
                         {% if movie.poster_image %}
                            <img src="{{ movie.poster_image.url }}" class="card-img-top movie-image" alt="{{ movie.title }}">
                         {% else %}
                            <img src="{% static 'images/placeholder.png' %}" class="card-img-top movie-image" alt="Placeholder">
                         {% endif %}
                     </a>
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title">{{ movie.title }}</h5>
                        <p class="card-text"><small class="text-muted">Released: {{ movie.release_year }}</small></p>
                        <a href="{% url 'movie_detail' movie.get_slug %}" class="btn btn-outline-primary mt-auto align-self-start">View Details</a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        <!-- End Movies Grid -->

        <!-- Pagination -->
        {% if movies.has_other_pages %}
        <nav aria-label="Page navigation" class="mt-5">
            <ul class="pagination justify-content-center">
                {% if movies.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ movies.previous_page_number }}&{{ request.GET.urlencode | cut:'page=' | cut:movies.previous_page_number }}" aria-label="Previous">
                            <span aria-hidden="true">&laquo;</span>
                        </a>
                    </li>
                {% else %}
                    <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
                {% endif %}

                {% for num in movies.paginator.page_range %}
                    {% if movies.number == num %}
                        <li class="page-item active" aria-current="page"><span class="page-link">{{ num }}</span></li>
                    {% elif num > movies.number|add:'-3' and num < movies.number|add:'3' %}
                        <li class="page-item"><a class="page-link" href="?page={{ num }}&{{ request.GET.urlencode | cut:'page=' | cut:num }}">{{ num }}</a></li>
                    {% elif num == movies.paginator.page_range.0 or num == movies.paginator.page_range|last %}
                         <li class="page-item disabled"><span class="page-link">...</span></li> {# Ellipsis for breaks #}
                    {% endif %}
                {% endfor %}

                {% if movies.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ movies.next_page_number }}&{{ request.GET.urlencode | cut:'page=' | cut:movies.next_page_number }}" aria-label="Next">
                            <span aria-hidden="true">&raquo;</span>
                        </a>
                    </li>
                {% else %}
                     <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
        <!-- End Pagination -->
    {% endif %} {# End check if movies exist #}
</div>
{% endblock %}
